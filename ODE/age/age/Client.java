/*
 * Commit: 1321c14e19d28de04c1ce157a5ba49c88dc1d41d
 * Date: 2023-10-19 14:06:33+02:00
 * Author: pre7618
 * Comment: Revert "Revert "Preliminary Stable""

This reverts commit a938d6d40d9fca1d16e44b64cf878f565aa227cf.

 *
 * Commit: a938d6d40d9fca1d16e44b64cf878f565aa227cf
 * Date: 2023-10-19 13:52:05+02:00
 * Author: pre7618
 * Comment: Revert "Preliminary Stable"

This reverts commit 30ce19cc9ff3501ad98913b4b766e28ed85b3a69.

 *
 * Commit: 30ce19cc9ff3501ad98913b4b766e28ed85b3a69
 * Date: 2023-10-15 23:11:22+02:00
 * Author: Philip Reichel
 * Comment: Preliminary Stable
 *
 * Commit: 6b8933b8c4570ceb6243fce4d47b80916217778b
 * Date: 2023-10-12 16:59:42+02:00
 * Author: pre7618
 * Comment: Apply Material and cleaning
 *
 * Commit: 5ca6d434e838bc3e560853f9915b1356e492c2fd
 * Date: 2023-10-12 14:59:48+02:00
 * Author: pre7618
 * Comment: Fixed The Signet
 *
 * Commit: 7407dc59dacb80fc02cd2de06a33b6b78cc37f8e
 * Date: 2023-10-12 13:32:56+02:00
 * Author: pre7618
 * Comment: Test
 *
 * Commit: abb79765d6c7fa32d18352f742be87ce2b7688c6
 * Date: 2023-10-12 05:01:43+02:00
 * Author: Philip Reichel
 * Comment: ,,
 *
 * Commit: 18d2f76ceedb6003ef53119b6e00bf0da3c4ff1d
 * Date: 2023-10-11 17:52:14+02:00
 * Author: pre7618
 * Comment: First Animated Rigged Mesh!
 *
 * Commit: e0cca43ebaf9325829b5493e1850af81809f2a4a
 * Date: 2023-10-10 11:04:22+02:00
 * Author: pre7618
 * Comment: Clean Version to Bring to HEAD
 *
 * Commit: 202d17c6d32f4a166bf665865bb5ff76a95cfbd8
 * Date: 2023-10-10 10:22:06+02:00
 * Author: pre7618
 * Comment: ...
 *
 * Commit: 543df522f819ea4a67e616d2be4c08edf6003716
 * Date: 2023-10-10 02:33:39+02:00
 * Author: Philip Reichel
 * Comment: ...
 *
 * Commit: e0af20930ce5c29d8c32b48b9731826e17bfa88d
 * Date: 2023-10-09 07:41:02+02:00
 * Author: Philip Reichel
 * Comment: ,,,
 *
 * Commit: eb306b1e6a0957eb9ec0dc0accbc1747e9f08d0f
 * Date: 2023-10-04 01:48:00+02:00
 * Author: Philip Reichel
 * Comment: ...
 *
 * Commit: 7a0e67a478c9bc474bec2860dbaccef928526344
 * Date: 2023-10-03 17:21:16+02:00
 * Author: Philip Reichel
 * Comment: ...
 *
 * Commit: ba5b9e40986cee624235e0e8e89889ccdd378e7a
 * Date: 2023-10-03 00:57:48+02:00
 * Author: Philip Reichel
 * Comment: ...
 *
 * Commit: 1d3937202c635d21dd0780fb7222445393a7b75a
 * Date: 2023-10-02 23:28:58+02:00
 * Author: Philip Reichel
 * Comment: Skeleton Reader hopefully working
 *
 * Commit: 79a5191fc4ca527a12fa7cf477631efa44a9b707
 * Date: 2023-10-02 01:54:44+02:00
 * Author: Philip Reichel
 * Comment: Done some stuff with meshes.
 *
 * Commit: 989a153341f09c0168f323a44e0ffec01fbc07b7
 * Date: 2023-10-01 22:26:41+02:00
 * Author: Philip Reichel
 * Comment: VBO babay
 *
 * Commit: 921fe26242fec8aea55ed85b831bf841b11304e4
 * Date: 2023-09-30 17:42:43+02:00
 * Author: Philip Reichel
 * Comment: Added Material Parsing
Added Models
Remove Bigfile
Added Models
Revert "Added Models"

This reverts commit cd0e7c6f40612113283cf9300c40af491cd1bc2f.

 *
 * Commit: 008260aa2a6ca875bcaaf414f516bbf13da3fad7
 * Date: 2023-09-29 22:59:02+02:00
 * Author: Philip Reichel
 * Comment: ...
 *
 * Commit: a6cfd8a75f5b4f72e889e58a8fbcb41ac4c94136
 * Date: 2023-09-29 14:56:21+02:00
 * Author: Philip Reichel
 * Comment: Added Simple Obj Loader
 *
 * Commit: 729ac252a97c3fd77734b2d841dfdd0ec3de55fb
 * Date: 2023-09-27 19:14:06+02:00
 * Author: Philip Reichel
 * Comment: ...
 *
 * Commit: c0bfaa9c91f29fe19c4b5f163ab85e7d619d5bd4
 * Date: 2023-09-27 16:44:29+02:00
 * Author: pre7618
 * Comment: ...
 *
 * Commit: 79126a233e35010f5ee69ea22119499909797737
 * Date: 2023-09-27 16:31:28+02:00
 * Author: pre7618
 * Comment: Added Camview and Rig
 *
 * Commit: 2c0280077398a4634180c45fd2854627002dba37
 * Date: 2023-09-26 23:59:37+02:00
 * Author: Philip Reichel
 * Comment: ...
 *
 * Commit: aa20ad72b29161d58217d659b23accf2664ef3cf
 * Date: 2023-09-26 23:19:19+02:00
 * Author: Philip Reichel
 * Comment: ...
 *
 * Commit: 34e6a4011238e92c515557e12cb6f1626e31d452
 * Date: 2023-09-26 16:12:59+02:00
 * Author: pre7618
 * Comment: ...
 *
 * Commit: ebb609a8fd7b6267ab2aa1c8e412e69fde248993
 * Date: 2023-09-26 16:03:29+02:00
 * Author: pre7618
 * Comment: ...
 *
 * Commit: 39b8f74293b119c48ba58cce6da3104541cab12a
 * Date: 2023-09-26 00:54:32+02:00
 * Author: Philip Reichel
 * Comment: Added Walker Animation
 *
 * Commit: fedc4377dc9249932eb67a8eb9e9a46dbec18ff0
 * Date: 2023-09-25 18:34:56+02:00
 * Author: pre7618
 * Comment: ...
 *
 * Commit: a9aeb73da12730709064899c6386be2c0baf809a
 * Date: 2023-09-25 02:26:54+02:00
 * Author: Philip Reichel
 * Comment: ...
 *
 * Commit: 4e914ceff796e6e44fd96c76252c68c7325e64cd
 * Date: 2023-09-25 01:23:31+02:00
 * Author: Philip Reichel
 * Comment: ...
 *
 * Commit: 01f6edb422e32c691886b08481b74af734d2419d
 * Date: 2023-09-25 00:22:26+02:00
 * Author: Philip Reichel
 * Comment: Added Mesh
 *
 * Commit: 9234eb72a89c40494fa4d9381686b27791a85924
 * Date: 2023-09-23 23:05:56+02:00
 * Author: Philip Reichel
 * Comment: ...
 *
 * Commit: 03165a40e9032ea45bb2863cf809767cb6cdf6f1
 * Date: 2023-09-23 20:52:58+02:00
 * Author: Philip Reichel
 * Comment: ...
 *
 * Commit: b9aac866e336cadf8afb32426af821162d9ade40
 * Date: 2023-09-23 18:35:56+02:00
 * Author: Philip Reichel
 * Comment: ...
 *
 * Commit: 1fd12df4cfeb1c4d67818231e6df4905af8afdef
 * Date: 2023-09-23 17:22:11+02:00
 * Author: Philip Reichel
 * Comment: Almost reworked Multiline
 *
 * Commit: 0c072ef17032c66ffdd34170f7a2c79345c34eae
 * Date: 2023-09-23 10:27:57+02:00
 * Author: Philip Reichel
 * Comment: Updated GUI Handling - Halfway done
 *
 * Commit: 84341809c117c5bfe4a2250eb07c27d65f20777f
 * Date: 2023-09-22 22:47:47+02:00
 * Author: Philip Reichel
 * Comment: ...
 *
 * Commit: 85cb5b7a1fbf0119b4e9bcb753640ca543e9e9a8
 * Date: 2023-09-22 22:29:04+02:00
 * Author: Philip Reichel
 * Comment: Adding Logs
 *
 * Commit: 8e1aad78b74edd61cd0e139ade57196ed44c219a
 * Date: 2023-09-22 22:14:40+02:00
 * Author: Philip Reichel
 * Comment: ...
 *
 * Commit: 023dbd552821f0d803d760c22a9f1193d1bf58b7
 * Date: 2023-09-22 21:50:52+02:00
 * Author: Philip Reichel
 * Comment: ...
 *
 * Commit: b669be6f6568945c41bf44a9085f269152f4a3ae
 * Date: 2023-09-22 20:53:50+02:00
 * Author: Philip Reichel
 * Comment: ...
 *
 * Commit: 755b11dea54fbe41e8bd4279fa3fa1d07e6fc2ea
 * Date: 2023-09-22 20:09:27+02:00
 * Author: Philip Reichel
 * Comment: ...
 *
 * Commit: 0843481a778d3a257ef3379baf70327d16287db0
 * Date: 2023-09-21 20:37:18+02:00
 * Author: Philip Reichel
 * Comment: ...
 *
 * Commit: 4ba52177b03c84982e184472f4e51a9157e9a67f
 * Date: 2023-09-21 20:15:06+02:00
 * Author: Philip Reichel
 * Comment: Cleaning all up
 *
 * Commit: d458c8f320674895dba3866cdd8fd198a68de073
 * Date: 2023-09-21 16:49:14+02:00
 * Author: pre7618
 * Comment: ..
 *
 * Commit: dd56eccbb9b27eab45e556efde8d3bb7d0f4ce97
 * Date: 2023-09-20 17:16:57+02:00
 * Author: pre7618
 * Comment: Renamings
 *
 * Commit: 9604372ca6ba2e1d98cb9220a960de47c6d7e589
 * Date: 2023-09-19 00:14:28+02:00
 * Author: Philip Reichel
 * Comment: ..
 *
 * Commit: c9fba54298823be83ab349a7f2e0eb3b2c607a44
 * Date: 2023-09-18 22:02:46+02:00
 * Author: Philip Reichel
 * Comment: upd
 *
 * Commit: abb7a2285eb44a4d16af09e9bd83ee60b2dd79a1
 * Date: 2023-09-18 16:42:36+02:00
 * Author: pre7618
 * Comment: ...
 *
 * Commit: b54d6ca45d357fd7c2c709c1bc575db7c096da88
 * Date: 2023-09-18 16:28:50+02:00
 * Author: pre7618
 * Comment: ..
 *
 * Commit: 28615d0198d72bb1e1667c0113a594237068a89d
 * Date: 2023-09-18 16:25:09+02:00
 * Author: pre7618
 * Comment: Added Scene Nodes
 *
 * Commit: f3bbe83125092b4a8cf308c82455a7fd16ccf366
 * Date: 2023-09-18 03:05:37+02:00
 * Author: Philip Reichel
 * Comment: Stuff
 *
 * Commit: 9c6fcc3d18bc3a80e598c208f13a03000d970911
 * Date: 2023-09-17 23:36:47+02:00
 * Author: Philip Reichel
 * Comment: API comments for age package.
 *
 * Commit: 87333d810752d046898c3c5fb42ced1dc49cfddb
 * Date: 2023-09-17 22:53:41+02:00
 * Author: Philip Reichel
 * Comment: Added Desktop Toggle
 *
 * Commit: a5ead4ac44938c7de5ec957407231948872a5000
 * Date: 2023-09-17 18:48:28+02:00
 * Author: Philip Reichel
 * Comment: Added Scroll Bar
 *
 * Commit: 059a758405028e46fcdd6cbef87c1c4ed3330712
 * Date: 2023-09-17 17:32:59+02:00
 * Author: Philip Reichel
 * Comment: Multitext
 *
 * Commit: 0a0626956b5c49e78d12757c077c1f9694a9dcc2
 * Date: 2023-09-16 21:35:52+02:00
 * Author: Philip Reichel
 * Comment: System Menu and Improved Messaging
 *
 * Commit: fe16e6ad57d7fe295d39edc19c9c2fc0d70fa0a1
 * Date: 2023-09-16 13:05:47+02:00
 * Author: Philip Reichel
 * Comment: Changed Handling a bit
Extended Logging
 *
 * Commit: 6989d6c19381cac7970d6f3736fe63e8a5f1af4e
 * Date: 2023-09-15 22:51:45+02:00
 * Author: Philip Reichel
 * Comment: Add Move and Resize to Frames
 *
 * Commit: 979912e4583b2e47ff4138caf044ae2005b4a274
 * Date: 2023-09-15 21:18:58+02:00
 * Author: Philip Reichel
 * Comment: Refactoring GUI Window Rendering
 *
 * Commit: 275f07861ea5f95dd90f184d1311a0a5a8cd510d
 * Date: 2023-09-14 17:55:15+02:00
 * Author: pre7618
 * Comment: GUI in progress
 *
 * Commit: d45900c73e4996bb998fd5104e99961af312eea3
 * Date: 2023-09-12 14:50:52+02:00
 * Author: pre7618
 * Comment: Added special Task phase
 *
 * Commit: 8dc6c41a602679fa36a34d3681764629b4ec6197
 * Date: 2023-09-12 13:19:01+02:00
 * Author: pre7618
 * Comment: Added Logging for AGE and Events thread safety
 *
 */

//*************************************************************************************************
package age;
//*************************************************************************************************

import age.port.Port;
import age.port.jogl.JOGLPort;
import age.scene.Camera;
import age.scene.NFlag;
import age.scene.Node;
import age.scene.NItem;
import age.scene.Scene;
import age.task.Tasks;
import age.util.MathUtil;
import javax.vecmath.Matrix4f;
import javax.vecmath.Vector3f;
import age.clock.Clock;
import age.gui.WFlag;
import age.gui.Widget;
import age.gui.GUI;
import age.input.Events;
import age.log.Level;
import age.log.Log;
import age.model.Animation;
import age.model.Factory;
import age.model.Influence;
import age.model.Model;
import age.model.Rig;

//*************************************************************************************************
public class Client {

	//=============================================================================================
	private Clock clock = new Clock();
	private Events events = new Events();
	private Scene scene = new Scene();
	private GUI gui = new GUI();
	private Tasks tasks = new Tasks();
	private Port port = new JOGLPort();
	private boolean running = false;  
	//=============================================================================================

	//=============================================================================================
	private Widget sysMenuFrame;
	//=============================================================================================
	
	//=============================================================================================
	public void run() {
		setup();
		loop();
	}
	//=============================================================================================

	//=============================================================================================
	private void setup() {
		
		port.create();

		dependencyInjections();

		setupScene();
		setupGUI();
		
		Log.info("Adjusting Port Window");
		port.position(150, 150);
		port.size(800, 600);
		
		Log.info("Setting Clock Tasks");	
		clock.addFPS(60, this::update);
		clock.addFPS(60, this::render);

	}
	//=============================================================================================

	//=============================================================================================
	private void dependencyInjections() {
		Log.info("Dependency Injections");
		port.assign(events);
		scene.assign(events);
		scene.assign(port);
		gui.assign(events);
		gui.assign(port);
		tasks.assign(events);
	}
	//=============================================================================================

	//=============================================================================================
	private void setupScene() {

		Log.info("Scene Setup");

		Node camNode = new Node();
		Camera camData = new Camera(45f, .4f, 1000f);
		camNode.component(NItem.CAMERA, camData);
		Matrix4f cm = MathUtil.rotY(150f);
		cm.setTranslation(new Vector3f(0, 2, 0));
		camNode.component(NItem.TRANSFORM, cm);
		scene.freeCamController().add(camNode);
		scene.camera(camNode);
		scene.root().attach(camNode);

		Model siglet = Factory.instance.siglet(30, 7);
		Node modelNode = new Node(NFlag.MODEL);
		modelNode.component(NItem.MODEL, siglet);
		scene.root().attach(modelNode);

		Model bmodel = Factory.instance.model("assets/stone/Stone.obj");
		Node bNode = new Node(NFlag.MODEL);
		bNode.component(NItem.MODEL, bmodel);
		modelNode.attach(bNode);

		Model ptmodel = Factory.instance.model("assets/palm_tree/10446_Palm_Tree_v1_max2010_iteration-2.obj");
		Matrix4f ptMx = new Matrix4f();
		ptMx.setIdentity();
		ptMx.rotX( (float) Math.toRadians(-90f));
		ptMx.setScale(0.01f);
		
		for (int i=0; i<100; i++) {
			float ds = (float) (Math.random() * 0.005f);
			float da = (float) (Math.random() * Math.PI * 2);
			float dd = 7f + (float) (Math.random() * 20f);
			float dx = (float) (Math.sin(da) * dd);
			float dz = (float) (Math.cos(da) * dd);
			Matrix4f ptMxC = new Matrix4f(ptMx);
			ptMxC.setTranslation(new Vector3f(dx, 0f, dz));
			ptMxC.setScale(ptMxC.getScale() + ds);
			Node ptNode = new Node(NFlag.MODEL);
			ptNode.component(NItem.MODEL, ptmodel);
			ptNode.component(NItem.TRANSFORM, ptMxC);
			modelNode.attach(ptNode);
		}
		
		Model model = Factory.instance.model("assets/yrig/yrig.obj");
		Animation animation = Factory.instance.animation("assets/yrig/yrig.bvh");
		Influence influence = new Influence(animation.skeleton, model.skin.mesh); 
		
		int n = 6;
		float r = 360f / n;
		for (int i=0; i<n; i++) {

			Node skelNode1 = new Node();
			skelNode1.component(NItem.TRANSFORM, MathUtil.rotY(i*r));
			skelNode1.component(NItem.TRANSFORM_ANIMATION, MathUtil.rotY(-12f));
			scene.animator().add(NFlag.TRANSFORM, skelNode1);
			
			Matrix4f m = new Matrix4f();
			Matrix4f m2 = new Matrix4f();
			m.rotX( (float) Math.toRadians(-90) );
			m2.rotY( (float) Math.toRadians(90) );
			m.mul(m2, m);
			m.setTranslation(new Vector3f(0, 0, -5));
			
			Node rigNode = new Node(NFlag.RIG);
			Rig rig = new Rig(animation, model, influence);
			rigNode.component(NItem.RIG, rig);
			scene.animator().add(NFlag.RIG, rigNode);
			rigNode.component(NItem.TRANSFORM, m);
			skelNode1.attach(rigNode);
			
			modelNode.attach(skelNode1);
		}
		
	}
	//=============================================================================================
	
	//=============================================================================================
	private void setupGUI() {

		Log.info("GUI Setup");
		
		age.gui.Factory factory = gui.factory(); 
		Widget root = gui.root();

		Widget btnSysmenu = factory.createIconButton("plus", "sysmenu");
		btnSysmenu.position(5, 5);
		root.add(btnSysmenu);
		
		sysMenuFrame = new Widget(WFlag.CANVAS, WFlag.VSTACK, WFlag.HIDDEN);
		gui.layouter().add(WFlag.VSTACK, sysMenuFrame);
		sysMenuFrame.position(0, 30);
		sysMenuFrame.add(factory.createIconButton("fullscreen", "fullscreen"));
		sysMenuFrame.add(factory.createIconButton("shutdown", "shutdown"));
		root.add(sysMenuFrame);
		
		Widget wnd = gui.factory().createWindow(800, 600, "HELLO HELLO!");
		Widget txt = gui.factory().createMultiLine("FDSFSAF DSF DF DF dsa fDS fSADf dsaf dsaF DSAf DSAf");
		txt.dimension(790, 565);
		txt.dock(0, 1, 0, 1);
		wnd.children().get(2).add(txt);
		wnd.position(100, 100);
		root.add(wnd);

		tasks.assign("fullscreen", this::toggleFullscreen);
		tasks.assign("shutdown", this::shutdown);
		tasks.assign("sysmenu", this::toggleSysmenu);
		
	}
	//=============================================================================================

	//=============================================================================================
	private void toggleSysmenu() {
		if (sysMenuFrame.match(WFlag.HIDDEN))
			sysMenuFrame.clear(WFlag.HIDDEN);
		else 
			sysMenuFrame.flag(WFlag.HIDDEN);
	}
	//=============================================================================================

	//=============================================================================================
	private void toggleFullscreen() {
		boolean toggle = !port.fullscreen();
		port.fullscreen(toggle);
	}
	//=============================================================================================

	//=============================================================================================
	private void loop() {
		running = true;
		Log.info("Entering Client Loop");
		port.visible(true);
		while (running) {
			clock.update();
		}
		port.visible(false);
		Log.info("Leaving Client Loop");
	}
	//=============================================================================================

	//=============================================================================================
	public void shutdown() {
		running = false;
	}
	//=============================================================================================
	
	//=============================================================================================
	private void render(
			int count,
			long nanoperiod,
			float dT) {
		scene.update(dT);
		port.render();
	}
	//=============================================================================================

	//=============================================================================================
	private void update(
			int count,
			long nanoperiod,
			float dT) {
		events.update();
		gui.update();
		tasks.update();
	}
	//=============================================================================================
	
	//=============================================================================================
	public static void main(String[] args) {
		Log.get("default").disable(Level.DEBUG);
		Log.info("Client Start");
		Client client = new Client();
		client.run();
		Log.info("Client Stop");
	}
	//=============================================================================================
	
}
//*************************************************************************************************
